<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro e Consulta de Vistoria</title>
  <style>
    :root {
      --azul: #00aeef;
      --azul-escuro: #0b132b;
      --preto: #05070f;
      --verde: #2ecc71;
      --cinza-card: #0f1c2e;
      --borda: rgba(255, 255, 255, 0.08);
      --texto: #eaf1f8;
      --texto-sec: #aab6c4;
      --vermelho: #ff6b6b;
      --amarelo: #f1c40f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, var(--azul-escuro), var(--preto));
      color: var(--texto);
    }

    .app {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h2 {
      text-align: center;
      color: var(--azul);
      margin-bottom: 20px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .abas {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .aba-btn {
      border: 1px solid var(--borda);
      color: var(--texto);
      background: #0b1a2f;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }

    .aba-btn.ativa {
      background: linear-gradient(135deg, #007cf0, #00dfd8);
      border: none;
    }

    .aba-conteudo { display: none; }
    .aba-conteudo.ativa { display: block; }

    .topo, .painel {
      background: var(--cinza-card);
      padding: 18px;
      border-radius: 18px;
      border: 1px solid var(--borda);
      margin-bottom: 20px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      align-items: end;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-top: 10px;
      display: block;
      color: var(--texto-sec);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid var(--borda);
      font-size: 14px;
      background: #0b1a2f;
      color: var(--texto);
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--azul);
      box-shadow: 0 0 0 2px rgba(0, 174, 239, 0.25);
    }

    textarea { resize: vertical; min-height: 60px; }

    button {
      border-radius: 12px;
      border: none;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
      opacity: 0.95;
    }

    .btn-id { background: linear-gradient(135deg, #007cf0, #00dfd8); color: #fff; margin-top: 18px; }
    .btn-voz { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; margin-top: 12px; }
    .btn-salvar { background: linear-gradient(135deg, var(--azul), var(--verde)); color: #fff; margin-top: 20px; }
    .btn-excluir-id { background: linear-gradient(135deg, #ff6b6b, #8e0000); color: #fff; }
    .btn-excluir { background: linear-gradient(135deg, #ff4d4d, #c0392b); color: #fff; margin-top: 10px; }
    .btn-consultar { background: linear-gradient(135deg, #8e44ad, #6c5ce7); color: #fff; }
    .btn-limpar { background: #34495e; color: #fff; }
    .btn-editar { background: linear-gradient(135deg, #f39c12, #d35400); color: #fff; }

    .box {
      background: var(--cinza-card);
      border-radius: 18px;
      padding: 18px;
      margin-top: 18px;
      border: 1px solid var(--borda);
    }

    .voz {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      padding: 14px;
      margin-top: 14px;
      border-left: 4px solid var(--verde);
    }

    .whatsapp { background: #25d366; color: #fff; margin-top: 10px; }

    .resultado-grupo {
      background: #0d1f35;
      border: 1px solid var(--borda);
      border-radius: 12px;
      margin-top: 16px;
      overflow: hidden;
    }

    .resultado-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--borda);
      font-weight: 600;
      color: var(--azul);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .resultado-item {
      padding: 12px 14px;
      border-bottom: 1px solid var(--borda);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    .resultado-item:last-child { border-bottom: none; }

    .acoes {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-block;
      border-radius: 99px;
      padding: 2px 9px;
      font-size: 12px;
      color: #111;
      font-weight: 700;
      background: var(--amarelo);
      margin-right: 8px;
    }

    .muted { color: var(--texto-sec); }
    .vazio { padding: 14px; color: var(--texto-sec); }
  </style>
</head>
<body>
  <div class="app">
    <h2>Cadastro de Vistoria</h2>

    <div class="abas">
      <button class="aba-btn ativa" onclick="trocarAba('cadastro', this)">Cadastro</button>
      <button class="aba-btn" onclick="trocarAba('consulta', this)">Consulta</button>
      <button class="aba-btn" id="abaEdicao" style="display:none" onclick="trocarAba('edicao', this)">Edi√ß√£o</button>
    </div>

    <section id="cadastro" class="aba-conteudo ativa">
      <div class="topo">
        <label>SGM</label>
        <input type="text" id="sgm" list="listaSGM" oninput="filtrarSGM()" onblur="buscarSGM()">
        <datalist id="listaSGM"></datalist>

        <label>Vistoriador</label>
        <select id="vistoriador">
          <option value="">Selecione</option>
        </select>
      </div>

      <div id="ids"></div>

      <button class="btn-id" onclick="adicionarID()">‚ûï Adicionar IDGOM</button>
      <button class="btn-salvar" onclick="salvar()">üíæ Salvar</button>
    </section>

    <section id="consulta" class="aba-conteudo">
      <div class="painel">
        <div class="grid-3">
          <div>
            <label>Pesquisar SGM</label>
            <input id="qSgm" type="text" placeholder="Ex.: SGM-123">
          </div>
          <div>
            <label>Pesquisar IDGOM</label>
            <input id="qId" type="text" placeholder="Ex.: 456789">
          </div>
          <div>
            <label>Pesquisar Estrutura</label>
            <input id="qEstrutura" type="text" placeholder="Ex.: P-10">
          </div>
        </div>
        <div class="acoes" style="margin-top:12px">
          <button class="btn-consultar" onclick="consultarRegistros()">üîé Consultar</button>
          <button class="btn-limpar" onclick="limparConsulta()">Limpar</button>
        </div>
      </div>

      <div id="resultadoConsulta" class="painel">
        <div class="vazio">Fa√ßa uma consulta para visualizar os registros agrupados.</div>
      </div>
    </section>

    <section id="edicao" class="aba-conteudo">
      <div class="painel">
        <h3 style="margin-top:0">Edi√ß√£o de Registro</h3>
        <p class="muted" style="margin-top:0">Ajuste os campos e clique em salvar edi√ß√£o.</p>

        <input type="hidden" id="editRegistroId">

        <label>SGM</label>
        <input id="editSgm" type="text">

        <div class="grid-3">
          <div>
            <label>Alimentador</label>
            <input id="editAlimentador" type="text">
          </div>
          <div>
            <label>IDGOM</label>
            <input id="editIdgom" type="text">
          </div>
          <div>
            <label>Estrutura</label>
            <input id="editEstrutura" type="text">
          </div>
        </div>

        <div class="grid-3">
          <div>
            <label>Voz</label>
            <input id="editVoz" type="text">
          </div>
          <div>
            <label>Quantidade</label>
            <input id="editQuantidade" type="number">
          </div>
          <div>
            <label>Tipo de Equipe</label>
            <input id="editTipoEquipe" type="text">
          </div>
        </div>

        <label>Observa√ß√£o</label>
        <input id="editObservacao" type="text">

        <label>Descri√ß√£o</label>
        <textarea id="editDescricao"></textarea>

        <div class="acoes" style="margin-top:14px">
          <button class="btn-salvar" onclick="salvarEdicao()">üíæ Salvar edi√ß√£o</button>
          <button class="btn-limpar" onclick="cancelarEdicao()">Cancelar</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw93FgcN2tkLrpI-33NQ0KNdk5GZEV9rVWHpXshOykyAur0meqZPK7lOSMNHZFnI_oCNw/exec";

    let sgms = [];
    let alimentadores = [];
    let idsSGM = [];
    let vozes = [];
    let observacoes = [];
    let tiposEquipe = [];

    async function executarNoBackend(funcao, parametros = null) {
  const sep = WEB_APP_URL.includes('?') ? '&' : '?';
  const url = `${WEB_APP_URL}${sep}action=${encodeURIComponent(funcao)}${
    parametros ? '&data=' + encodeURIComponent(JSON.stringify(parametros)) : ''
  }&_=${Date.now()}`;

  const response = await fetch(url);
  const texto = await response.text();

  // Se vier HTML, √© erro/permiss√£o e o navegador ‚Äúdisfar√ßa‚Äù como CORS
  if (texto.trim().startsWith('<')) {
    console.error('Backend retornou HTML:', texto.slice(0, 300));
    return null;
  }

  return JSON.parse(texto);
}



    function trocarAba(idAba, botao = null) {
      document.querySelectorAll('.aba-conteudo').forEach(sec => sec.classList.remove('ativa'));
      document.querySelectorAll('.aba-btn').forEach(btn => btn.classList.remove('ativa'));
      document.getElementById(idAba)?.classList.add('ativa');
      if (botao) botao.classList.add('ativa');
    }

    async function carregarDadosIniciais() {
      const listaSGM = await executarNoBackend('buscarListaSGM');
      if (listaSGM) {
        sgms = listaSGM;
        atualizarListaSGM(sgms);
      }

      const listaVist = await executarNoBackend('buscarVistoriadores');
      if (listaVist) {
        const select = document.getElementById('vistoriador');
        select.innerHTML = '<option value="">Selecione</option>';
        listaVist.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });
      }

      vozes = await executarNoBackend('buscarVozes') || [];
      observacoes = await executarNoBackend('buscarObservacoes') || [];
      tiposEquipe = await executarNoBackend('buscarTiposEquipe') || [];
    }

    function filtrarSGM() {
      const valor = document.getElementById('sgm').value.toLowerCase();
      const filtrados = sgms.filter(s => s.toLowerCase().includes(valor));
      atualizarListaSGM(filtrados);
    }

    function atualizarListaSGM(lista) {
      const datalist = document.getElementById('listaSGM');
      datalist.innerHTML = '';
      lista.forEach(sgm => {
        const opt = document.createElement('option');
        opt.value = sgm;
        datalist.appendChild(opt);
      });
    }

    async function buscarSGM() {
      const sgm = document.getElementById('sgm').value;
      if (!sgm) return;
      const d = await executarNoBackend('buscarDadosSGM', { sgm });
      if (d) {
        alimentadores = d.alimentadores || [];
        idsSGM = d.ids || [];
      }
    }

    function adicionarID() {
      const div = document.createElement('div');
      div.className = 'box';
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <strong style="color:#00AEEF">IDGOM</strong>
          <button class="btn-excluir-id" onclick="excluirIDGOM(this)">üóëÔ∏è Excluir IDGOM</button>
        </div>
        <label>Alimentador</label>
        <input list="listaAlimentador">
        <datalist id="listaAlimentador">${alimentadores.map(a => `<option value="${a}">`).join('')}</datalist>
        <label>IDGOM</label>
        <input list="listaIDGOM">
        <datalist id="listaIDGOM">${idsSGM.map(i => `<option value="${i}">`).join('')}</datalist>
        <label>Estrutura</label>
        <input type="text">
        <div class="vozes"></div>
        <button class="btn-voz" onclick="adicionarVoz(this)">‚ûï Adicionar Voz</button>
      `;
      document.getElementById('ids').appendChild(div);
    }

    function adicionarVoz(botao) {
      const divVoz = document.createElement('div');
      divVoz.className = 'voz';
      divVoz.innerHTML = `
        <label>Voz</label>
        <select>${vozes.map(v => `<option value="${v}">${v}</option>`).join('')}</select>
        <label>Quantidade</label>
        <input type="number">
        <label>Observa√ß√£o</label>
        <select onchange="verificaWhats(this)">${observacoes.map(o => `<option value="${o}">${o}</option>`).join('')}</select>
        <label>Descri√ß√£o</label>
        <textarea></textarea>
        <label>Tipo de Equipe</label>
        <select>${tiposEquipe.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
        <button class="whatsapp" style="display:none" onclick="enviarWhats(this)">üì≤ Enviar WhatsApp</button>
        <button class="btn-excluir" onclick="excluirVoz(this)">üóëÔ∏è Excluir Voz</button>
      `;
      botao.previousElementSibling.appendChild(divVoz);
    }

    function normalizarTexto(valor) {
      return String(valor || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim().toLowerCase();
    }

    function verificaWhats(select) {
      const btn = select.closest('.voz')?.querySelector('.whatsapp');
      if (!btn) return;
      btn.style.display = normalizarTexto(select.value) === 'poda extra' ? 'block' : 'none';
    }

    function enviarWhats(btn) {
      const box = btn.closest('.box');
      const texto = `Projeto (SGM): ${document.getElementById('sgm').value}
Alimentador: ${box.querySelectorAll('input')[0].value}
Estrutura: ${box.querySelectorAll('input')[2].value}
IDGOM: ${box.querySelectorAll('input')[1].value}
Descri√ß√£o: ${btn.parentElement.querySelector('textarea').value}`.trim();
      window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`);
    }

    async function salvar() {
      const payload = {
        sgm: document.getElementById('sgm').value,
        vistoriador: document.getElementById('vistoriador').value,
        registros: []
      };

      document.querySelectorAll('.box').forEach(box => {
        const inputs = box.querySelectorAll('input');
        const alimentador = inputs[0].value;
        const idgom = inputs[1].value;
        const estrutura = inputs[2].value;

        box.querySelectorAll('.voz').forEach(v => {
          const selects = v.querySelectorAll('select');
          payload.registros.push({
            alimentador,
            idgom,
            estrutura,
            voz: selects[0].value,
            quantidade: v.querySelector('input').value,
            observacao: selects[1].value,
            descricao: v.querySelector('textarea').value,
            tipoEquipe: selects[2].value
          });
        });
      });

      const senha = prompt('Digite sua senha:');
      if (!senha) return alert('Senha obrigat√≥ria.');

      const res = await executarNoBackend('salvarBaseComSenha', { payload, senha });
      if (res && res.ok) {
        alert('Dados salvos com sucesso!');
      } else {
        alert('Erro ou senha incorreta.');
      }
    }

    function excluirVoz(botao) {
      if (confirm('Deseja excluir esta voz?')) botao.closest('.voz').remove();
    }

    function excluirIDGOM(botao) {
      if (confirm('Deseja excluir este IDGOM?')) botao.closest('.box').remove();
    }

    function limparConsulta() {
      document.getElementById('qSgm').value = '';
      document.getElementById('qId').value = '';
      document.getElementById('qEstrutura').value = '';
      document.getElementById('resultadoConsulta').innerHTML = '<div class="vazio">Fa√ßa uma consulta para visualizar os registros agrupados.</div>';
    }

    async function consultarRegistros() {
      const filtros = {
        sgm: document.getElementById('qSgm').value.trim(),
        idgom: document.getElementById('qId').value.trim(),
        estrutura: document.getElementById('qEstrutura').value.trim()
      };

      const resultadoBox = document.getElementById('resultadoConsulta');
      resultadoBox.innerHTML = '<div class="vazio">Consultando...</div>';

      const dados = await executarNoBackend('consultarRegistros', filtros);
      const lista = Array.isArray(dados) ? dados : dados?.registros || [];

      if (!lista.length) {
        resultadoBox.innerHTML = '<div class="vazio">Nenhum registro encontrado para os filtros informados.</div>';
        return;
      }

      renderizarConsultaAgrupada(lista);
    }

    function renderizarConsultaAgrupada(lista) {
      const agrupado = {};
      lista.forEach(item => {
        const sgm = item.sgm || 'Sem SGM';
        const idgom = item.idgom || 'Sem IDGOM';
        const estrutura = item.estrutura || 'Sem Estrutura';
        agrupado[sgm] ??= {};
        agrupado[sgm][idgom] ??= {};
        agrupado[sgm][idgom][estrutura] ??= [];
        agrupado[sgm][idgom][estrutura].push(item);
      });

      const resultadoBox = document.getElementById('resultadoConsulta');
      resultadoBox.innerHTML = '';

      Object.entries(agrupado).forEach(([sgm, porId]) => {
        Object.entries(porId).forEach(([idgom, porEstrutura]) => {
          Object.entries(porEstrutura).forEach(([estrutura, itens]) => {
            const grupo = document.createElement('div');
            grupo.className = 'resultado-grupo';
            grupo.innerHTML = `
              <div class="resultado-header">
                <div>
                  <span class="badge">${itens.length} registro(s)</span>
                  SGM: ${sgm} | IDGOM: ${idgom} | Estrutura: ${estrutura}
                </div>
              </div>
            `;

            itens.forEach(reg => {
              const item = document.createElement('div');
              item.className = 'resultado-item';
              item.innerHTML = `
                <div>
                  <strong>Voz:</strong> ${reg.voz || '-'} &nbsp; 
                  <strong>Qtd:</strong> ${reg.quantidade || '-'} &nbsp; 
                  <strong>Obs:</strong> ${reg.observacao || '-'}<br>
                  <span class="muted"><strong>Descri√ß√£o:</strong> ${reg.descricao || '-'} | <strong>Equipe:</strong> ${reg.tipoEquipe || '-'}</span>
                </div>
                <div class="acoes">
                  <button class="btn-editar" onclick='abrirEdicao(${JSON.stringify(reg)})'>‚úèÔ∏è Editar</button>
                  <button class="btn-excluir" onclick='excluirRegistro(${JSON.stringify(reg)})'>üóëÔ∏è Excluir</button>
                </div>
              `;
              grupo.appendChild(item);
            });

            resultadoBox.appendChild(grupo);
          });
        });
      });
    }

    function abrirEdicao(registro) {
      document.getElementById('abaEdicao').style.display = 'inline-block';
      document.getElementById('editRegistroId').value = registro.id || registro.linha || '';
      document.getElementById('editSgm').value = registro.sgm || '';
      document.getElementById('editAlimentador').value = registro.alimentador || '';
      document.getElementById('editIdgom').value = registro.idgom || '';
      document.getElementById('editEstrutura').value = registro.estrutura || '';
      document.getElementById('editVoz').value = registro.voz || '';
      document.getElementById('editQuantidade').value = registro.quantidade || '';
      document.getElementById('editObservacao').value = registro.observacao || '';
      document.getElementById('editDescricao').value = registro.descricao || '';
      document.getElementById('editTipoEquipe').value = registro.tipoEquipe || '';
      trocarAba('edicao', document.getElementById('abaEdicao'));
    }

    async function salvarEdicao() {
      const payload = {
        id: document.getElementById('editRegistroId').value,
        sgm: document.getElementById('editSgm').value,
        alimentador: document.getElementById('editAlimentador').value,
        idgom: document.getElementById('editIdgom').value,
        estrutura: document.getElementById('editEstrutura').value,
        voz: document.getElementById('editVoz').value,
        quantidade: document.getElementById('editQuantidade').value,
        observacao: document.getElementById('editObservacao').value,
        descricao: document.getElementById('editDescricao').value,
        tipoEquipe: document.getElementById('editTipoEquipe').value
      };

      const senha = prompt('Digite sua senha para editar:');
      if (!senha) return alert('Senha obrigat√≥ria.');

      const res = await executarNoBackend('editarRegistroComSenha', { payload, senha });
      if (res && res.ok) {
        alert('Registro editado com sucesso!');
        trocarAba('consulta', document.querySelectorAll('.aba-btn')[1]);
        consultarRegistros();
      } else {
        alert('N√£o foi poss√≠vel editar. Verifique a senha e o backend.');
      }
    }

    function cancelarEdicao() {
      document.getElementById('abaEdicao').style.display = 'none';
      trocarAba('consulta', document.querySelectorAll('.aba-btn')[1]);
    }

    async function excluirRegistro(registro) {
      if (!confirm('Deseja realmente excluir este registro?')) return;

      const senha = prompt('Digite sua senha para excluir:');
      if (!senha) return alert('Senha obrigat√≥ria.');

      const payload = {
        id: registro.id || registro.linha || null,
        sgm: registro.sgm,
        idgom: registro.idgom,
        estrutura: registro.estrutura,
        voz: registro.voz
      };

      const res = await executarNoBackend('excluirRegistroComSenha', { payload, senha });
      if (res && res.ok) {
        alert('Registro exclu√≠do com sucesso!');
        consultarRegistros();
      } else {
        alert('Falha ao excluir. Ajuste o backend para aceitar os par√¢metros enviados.');
      }
    }

    window.onload = carregarDadosIniciais;
  </script>
</body>
</html>
