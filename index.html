<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro e Consulta de Vistoria</title>
  <style>
    /* ... TODOS OS SEUS ESTILOS ORIGINAIS ... */
    :root {
      --azul: #00aeef;
      --azul-escuro: #0b132b;
      --preto: #05070f;
      --verde: #2ecc71;
      --cinza-card: #0f1c2e;
      --borda: rgba(255, 255, 255, 0.08);
      --texto: #eaf1f8;
      --texto-sec: #aab6c4;
      --vermelho: #ff6b6b;
      --amarelo: #f1c40f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, var(--azul-escuro), var(--preto));
      color: var(--texto);
    }
    .app { width: 100%; max-width: 1200px; margin: 0 auto; padding: 24px 16px 40px; }
    h2 { text-align: center; color: var(--azul); margin-bottom: 20px; font-weight: 600; letter-spacing: 1px; }
    .abas { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .aba-btn { border: 1px solid var(--borda); color: var(--texto); background: #0b1a2f; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
    .aba-btn.ativa { background: linear-gradient(135deg, #007cf0, #00dfd8); border: none; }
    .aba-conteudo { display: none; }
    .aba-conteudo.ativa { display: block; }
    .topo, .painel { background: var(--cinza-card); padding: 18px; border-radius: 18px; border: 1px solid var(--borda); margin-bottom: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; align-items: end; }
    label { font-size: 12px; font-weight: 600; margin-top: 10px; display: block; color: var(--texto-sec); }
    input, select, textarea { width: 100%; padding: 10px 12px; margin-top: 6px; border-radius: 10px; border: 1px solid var(--borda); font-size: 14px; background: #0b1a2f; color: var(--texto); }
    button { border-radius: 12px; border: none; padding: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-id { background: linear-gradient(135deg, #007cf0, #00dfd8); color: #fff; margin-top: 18px; width: 100%; }
    .btn-voz { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; margin-top: 12px; width: 100%; }
    .btn-salvar { background: linear-gradient(135deg, var(--azul), var(--verde)); color: #fff; margin-top: 20px; width: 100%; }
    .btn-excluir-id { background: linear-gradient(135deg, #ff6b6b, #8e0000); color: #fff; }
    .btn-excluir { background: linear-gradient(135deg, #ff4d4d, #c0392b); color: #fff; margin-top: 10px; }
    .btn-consultar { background: linear-gradient(135deg, #44ad9f, #2c80ff); color: #fff; }
    .btn-limpar { background: #34495e; color: #fff; }
    .btn-editar { background: linear-gradient(135deg, #f39c12, #d35400); color: #fff; }
    .box { background: var(--cinza-card); border-radius: 18px; padding: 18px; margin-top: 18px; border: 1px solid var(--borda); }
    .voz { background: rgba(255, 255, 255, 0.03); border-radius: 14px; padding: 14px; margin-top: 14px; border-left: 4px solid var(--verde); }
    .whatsapp { background: #25d366; color: #fff; margin-top: 10px; width: 100%; }
    .resultado-grupo { background: #0d1f35; border: 1px solid var(--borda); border-radius: 12px; margin-top: 16px; overflow: hidden; }
    .resultado-header { padding: 12px 14px; border-bottom: 1px solid var(--borda); font-weight: 600; color: var(--azul); display: flex; justify-content: space-between; }
    .resultado-item { padding: 12px 14px; border-bottom: 1px solid var(--borda); display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    .badge { border-radius: 99px; padding: 2px 9px; font-size: 12px; color: #111; font-weight: 700; background: var(--amarelo); margin-right: 8px; }
    .muted { color: var(--texto-sec); font-size: 13px; }
    .vazio { padding: 14px; color: var(--texto-sec); text-align: center; }
  </style>
</head>
<body>
  <div class="app">
    <h2>Cadastro de Vistoria</h2>

    <div class="abas">
      <button class="aba-btn ativa" onclick="trocarAba('cadastro', this)">Cadastro</button>
      <button class="aba-btn" onclick="trocarAba('consulta', this)">Consulta</button>
      <button class="aba-btn" id="abaEdicao" style="display:none" onclick="trocarAba('edicao', this)">Edi√ß√£o</button>
    </div>

    <!-- SE√á√ÉO CADASTRO -->
    <section id="cadastro" class="aba-conteudo ativa">
      <div class="topo">
        <label>SGM</label>
        <input type="text" id="sgm" list="listaSGM" oninput="filtrarSGM()" onblur="buscarSGM()">
        <datalist id="listaSGM"></datalist>

        <label>Vistoriador</label>
        <select id="vistoriador">
          <option value="">Selecione</option>
        </select>
      </div>

      <div id="ids"></div>

      <button class="btn-id" onclick="adicionarID()">‚ûï Adicionar IDGOM</button>
      <button class="btn-salvar" onclick="salvar()">üíæ Salvar</button>
    </section>

    <!-- SE√á√ÉO CONSULTA -->
    <section id="consulta" class="aba-conteudo">
      <div class="painel">
        <div class="grid-3">
          <div><label>Pesquisar SGM</label><input id="qSgm" type="text" placeholder="Ex.: SGM-123"></div>
          <div><label>Pesquisar IDGOM</label><input id="qId" type="text" placeholder="Ex.: 456789"></div>
          <div><label>Pesquisar Estrutura</label><input id="qEstrutura" type="text" placeholder="Ex.: P-10"></div>
        </div>
        <div class="acoes" style="margin-top:12px; display: flex; gap: 8px;">
          <button class="btn-consultar" onclick="consultarRegistros()">üîé Consultar</button>
          <button class="btn-limpar" onclick="limparConsulta()">Limpar</button>
        </div>
      </div>
      <div id="resultadoConsulta" class="painel">
        <div class="vazio">Fa√ßa uma consulta para visualizar os registros agrupados.</div>
      </div>
    </section>

    <!-- SE√á√ÉO EDI√á√ÉO -->
    <section id="edicao" class="aba-conteudo">
      <div class="painel">
        <h3 style="margin-top:0">Edi√ß√£o de Registro</h3>
        <input type="hidden" id="editRegistroId">
        <label>SGM</label><input id="editSgm" type="text">
        <div class="grid-3">
          <div><label>Alimentador</label><input id="editAlimentador" type="text"></div>
          <div><label>IDGOM</label><input id="editIdgom" type="text"></div>
          <div><label>Estrutura</label><input id="editEstrutura" type="text"></div>
        </div>
        <div class="grid-3">
          <div><label>Voz</label><input id="editVoz" type="text"></div>
          <div><label>Quantidade</label><input id="editQuantidade" type="number"></div>
          <div><label>Tipo de Equipe</label><input id="editTipoEquipe" type="text"></div>
        </div>
        <label>Observa√ß√£o</label><input id="editObservacao" type="text">
        <label>Descri√ß√£o</label><textarea id="editDescricao"></textarea>
        <div class="acoes" style="margin-top:14px; display: flex; gap: 8px;">
          <button class="btn-salvar" onclick="salvarEdicao()">üíæ Salvar edi√ß√£o</button>
          <button class="btn-limpar" onclick="cancelarEdicao()">Cancelar</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-t9TfYJ4jo998urTIBacQPGaMTwErCiy0KssOlrQZfU5bJzV0OjzKAJ3Rt3rLVv_MWA/exec";

    let sgms = [], alimentadores = [], idsSGM = [], vozes = [], observacoes = [], tiposEquipe = [];

    // --- FUN√á√ÉO DE CONEX√ÉO JSONP ---
    function executarNoBackend(funcao, parametros = null) {
      return new Promise((resolve) => {
        const cb = `cb_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
        window[cb] = (data) => {
          resolve(data);
          delete window[cb];
          document.body.removeChild(script);
        };
        const script = document.createElement('script');
        const sep = WEB_APP_URL.includes('?') ? '&' : '?';
        const dataStr = encodeURIComponent(JSON.stringify(parametros));
        script.src = `${WEB_APP_URL}${sep}action=${funcao}&data=${dataStr}&callback=${cb}`;
        document.body.appendChild(script);
      });
    }

    function trocarAba(idAba, botao = null) {
      document.querySelectorAll('.aba-conteudo').forEach(sec => sec.classList.remove('ativa'));
      document.querySelectorAll('.aba-btn').forEach(btn => btn.classList.remove('ativa'));
      document.getElementById(idAba)?.classList.add('ativa');
      if (botao) botao.classList.add('ativa');
    }

    async function carregarDadosIniciais() {
      sgms = await executarNoBackend('buscarListaSGM') || [];
      atualizarListaSGM(sgms);
      
      const vists = await executarNoBackend('buscarVistoriadores') || [];
      const sel = document.getElementById('vistoriador');
      vists.forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);

      vozes = await executarNoBackend('buscarVozes') || [];
      observacoes = await executarNoBackend('buscarObservacoes') || [];
      tiposEquipe = await executarNoBackend('buscarTiposEquipe') || [];
      adicionarID(); 
    }

    function filtrarSGM() {
      const val = document.getElementById('sgm').value.toLowerCase();
      atualizarListaSGM(sgms.filter(s => s.toLowerCase().includes(val)));
    }

    function atualizarListaSGM(lista) {
      const dl = document.getElementById('listaSGM');
      dl.innerHTML = lista.map(s => `<option value="${s}">`).join('');
    }

    async function buscarSGM() {
      const sgm = document.getElementById('sgm').value;
      if (!sgm) return;
      const d = await executarNoBackend('buscarDadosSGM', { sgm });
      if (d) {
        alimentadores = d.alimentadores || [];
        idsSGM = d.ids || [];
      }
    }

    function adicionarID() {
      const div = document.createElement('div');
      div.className = 'box';
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
          <strong style="color:var(--azul)">IDGOM</strong>
          <button class="btn-excluir-id" onclick="this.closest('.box').remove()">üóëÔ∏è Excluir</button>
        </div>
        <label>Alimentador</label><input list="listaAlm" class="f-alm">
        <datalist id="listaAlm">${alimentadores.map(a => `<option value="${a}">`).join('')}</datalist>
        <label>IDGOM</label><input list="listaId" class="f-id">
        <datalist id="listaId">${idsSGM.map(i => `<option value="${i}">`).join('')}</datalist>
        <label>Estrutura</label><input type="text" class="f-est">
        <div class="vozes-container"></div>
        <button class="btn-voz" onclick="adicionarVoz(this)">‚ûï Adicionar Voz</button>
      `;
      document.getElementById('ids').appendChild(div);
    }

    function adicionarVoz(btn) {
      const div = document.createElement('div');
      div.className = 'voz';
      div.innerHTML = `
        <label>Voz</label><select class="v-voz">${vozes.map(v => `<option value="${v}">${v}</option>`).join('')}</select>
        <label>Quantidade</label><input type="number" class="v-qtd">
        <label>Observa√ß√£o</label><select class="v-obs" onchange="verificaWhats(this)">${observacoes.map(o => `<option value="${o}">${o}</option>`).join('')}</select>
        <label>Descri√ß√£o</label><textarea class="v-desc"></textarea>
        <label>Tipo de Equipe</label><select class="v-tipo">${tiposEquipe.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
        <button class="whatsapp" style="display:none" onclick="enviarWhats(this)">üì≤ Enviar WhatsApp</button>
        <button class="btn-excluir" onclick="this.closest('.voz').remove()">üóëÔ∏è Excluir Voz</button>
      `;
      btn.previousElementSibling.appendChild(div);
    }

    function verificaWhats(sel) {
      const btn = sel.closest('.voz').querySelector('.whatsapp');
      btn.style.display = sel.value.toLowerCase().includes('poda extra') ? 'block' : 'none';
    }

    function enviarWhats(btn) {
      const box = btn.closest('.box');
      const texto = `SGM: ${document.getElementById('sgm').value}\nID: ${box.querySelector('.f-id').value}\nEst: ${box.querySelector('.f-est').value}\nDesc: ${btn.closest('.voz').querySelector('.v-desc').value}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`);
    }

    async function salvar() {
      const payload = {
        sgm: document.getElementById('sgm').value,
        vistoriador: document.getElementById('vistoriador').value,
        registros: []
      };
      if(!payload.sgm || !payload.vistoriador) return alert("SGM e Vistoriador obrigat√≥rios");

      document.querySelectorAll('.box').forEach(box => {
        const alm = box.querySelector('.f-alm').value;
        const idgom = box.querySelector('.f-id').value;
        const est = box.querySelector('.f-est').value;
        box.querySelectorAll('.voz').forEach(v => {
          payload.registros.push({
            alimentador: alm, idgom: idgom, estrutura: est,
            voz: v.querySelector('.v-voz').value,
            quantidade: v.querySelector('.v-qtd').value,
            observacao: v.querySelector('.v-obs').value,
            descricao: v.querySelector('.v-desc').value,
            tipoEquipe: v.querySelector('.v-tipo').value
          });
        });
      });

      const senha = prompt('Digite sua senha:');
      if (!senha) return;
      const res = await executarNoBackend('salvarBaseComSenha', { payload, senha });
      if (res?.ok) { alert('Salvo!'); location.reload(); } else alert('Erro!');
    }

    async function consultarRegistros() {
      const filtros = {
        sgm: document.getElementById('qSgm').value,
        idgom: document.getElementById('qId').value,
        estrutura: document.getElementById('qEstrutura').value
      };
      const res = await executarNoBackend('consultarRegistros', filtros);
      renderizarConsultaAgrupada(res || []);
    }

    function renderizarConsultaAgrupada(lista) {
      const resBox = document.getElementById('resultadoConsulta');
      resBox.innerHTML = lista.length ? '' : '<div class="vazio">Nenhum registro.</div>';
      
      lista.forEach(reg => {
        const grupo = document.createElement('div');
        grupo.className = 'resultado-grupo';
        grupo.innerHTML = `
          <div class="resultado-header">SGM: ${reg.sgm} | ID: ${reg.idgom} | Est: ${reg.estrutura}</div>
          <div class="resultado-item">
            <div><strong>Voz:</strong> ${reg.voz} | <strong>Qtd:</strong> ${reg.quantidade} | <strong>Equipe:</strong> ${reg.tipo_de_equipe}</div>
            <div class="acoes">
              <button class="btn-editar" onclick='abrirEdicao(${JSON.stringify(reg)})'>‚úèÔ∏è</button>
              <button class="btn-excluir" onclick='excluirRegistro(${JSON.stringify(reg)})'>üóëÔ∏è</button>
            </div>
          </div>
        `;
        resBox.appendChild(grupo);
      });
    }

    function abrirEdicao(reg) {
      document.getElementById('abaEdicao').style.display = 'inline-block';
      document.getElementById('editRegistroId').value = reg.linha;
      document.getElementById('editSgm').value = reg.sgm;
      document.getElementById('editAlimentador').value = reg.alimentador;
      document.getElementById('editIdgom').value = reg.idgom;
      document.getElementById('editEstrutura').value = reg.estrutura;
      document.getElementById('editVoz').value = `${reg.voz} - ${reg.descri√ß√£o}`;
      document.getElementById('editQuantidade').value = reg.quantidade;
      document.getElementById('editObservacao').value = reg.observa√ß√£o;
      document.getElementById('editDescricao').value = reg.descri√ß√£o_da_voz;
      document.getElementById('editTipoEquipe').value = reg.tipo_de_equipe;
      trocarAba('edicao', document.getElementById('abaEdicao'));
    }

    async function salvarEdicao() {
      const payload = {
        id: document.getElementById('editRegistroId').value,
        sgm: document.getElementById('editSgm').value,
        alimentador: document.getElementById('editAlimentador').value,
        idgom: document.getElementById('editIdgom').value,
        estrutura: document.getElementById('editEstrutura').value,
        voz: document.getElementById('editVoz').value,
        quantidade: document.getElementById('editQuantidade').value,
        observacao: document.getElementById('editObservacao').value,
        descricao: document.getElementById('editDescricao').value,
        tipoEquipe: document.getElementById('editTipoEquipe').value
      };
      const senha = prompt('Senha:');
      const res = await executarNoBackend('editarRegistroComSenha', { payload, senha });
      if(res?.ok) { alert('Editado!'); trocarAba('consulta'); consultarRegistros(); } else alert('Erro!');
    }

    async function excluirRegistro(reg) {
      const senha = prompt('Senha:');
      const res = await executarNoBackend('excluirRegistroComSenha', { payload: { id: reg.linha }, senha });
      if(res?.ok) { alert('Exclu√≠do!'); consultarRegistros(); } else alert('Erro!');
    }

    function cancelarEdicao() { document.getElementById('abaEdicao').style.display = 'none'; trocarAba('consulta'); }

    window.onload = carregarDadosIniciais;
  </script>
</body>
</html>