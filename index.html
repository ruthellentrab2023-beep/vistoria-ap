<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro e Consulta de Vistorias</title>

  <style>

.btn-salvar-mini {
  background: var(--azul);
  color: white;
  font-size: 12px;
  padding: 8px;
  margin-bottom: 5px;
}
.editando {
  background: #162a45 !important;
  border: 1px solid var(--azul) !important;
}

    /* CONTAINER PRINCIPAL */
    .app {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    .btn-excluir-id {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
      padding: 6px 12px;
    }

    .btn-excluir {
      background: rgba(255, 107, 107, 0.15);
      color: #ff6b6b;
      padding: 6px 12px;
      margin-top: 10px;
      width: 100%;
    }

    :root {
      --azul: #00AEEF;
      --azul-escuro: #0b132b;
      --preto: #05070f;
      --verde: #2ECC71;
      --cinza-card: #0f1c2e;
      --borda: rgba(255,255,255,0.08);
      --texto: #eaf1f8;
      --texto-sec: #aab6c4;
      --amarelo: #f1c40f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, var(--azul-escuro), var(--preto));
      color: var(--texto);
    }

    h2 {
      text-align: center;
      color: var(--azul);
      margin-bottom: 18px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-top: 14px;
      display: block;
      color: var(--texto-sec);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid var(--borda);
      font-size: 14px;
      background: #0b1a2f;
      color: var(--texto);
      transition: border 0.2s, box-shadow 0.2s;
    }

    input::placeholder { color: #7f8ea3; }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--azul);
      box-shadow: 0 0 0 2px rgba(0,174,239,0.25);
    }

    textarea { resize: vertical; min-height: 60px; }

    button {
      border-radius: 12px;
      border: none;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      opacity: 0.95;
    }

    /* Bot√µes */
    .btn-id {
      background: linear-gradient(135deg, #007cf0, #00dfd8);
      color: #fff;
      margin-top: 18px;
      width: 100%;
    }

    .btn-voz {
      background: linear-gradient(135deg, #2ECC71, #27ae60);
      color: #fff;
      margin-top: 12px;
      width: 100%;
    }

    .btn-salvar {
      background: linear-gradient(135deg, var(--azul), var(--verde));
      color: #fff;
      margin-top: 24px;
      width: 100%;
    }

    .btn-consultar {
      background: linear-gradient(135deg, #44ad9f, #2c80ff);
      color: #fff;
    }

    .btn-limpar {
      background: #34495e;
      color: #fff;
    }

    .box {
      background: var(--cinza-card);
      border-radius: 18px;
      padding: 18px;
      margin-top: 22px;
      border: 1px solid var(--borda);
    }

    .voz {
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 14px;
      margin-top: 14px;
      border-left: 4px solid var(--verde);
    }

    .whatsapp {
      background: #25D366;
      color: #fff;
      margin-top: 10px;
      width: 100%;
    }

    .topo {
      background: var(--cinza-card);
      padding: 18px;
      border-radius: 18px;
      border: 1px solid var(--borda);
      margin-bottom: 18px;
    }

    /* ABAS (da ideia do index, adaptado pro seu estilo) */
    .abas {
      display: flex;
      gap: 8px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .aba-btn {
      border: 1px solid var(--borda);
      color: var(--texto);
      background: #0b1a2f;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .aba-btn.ativa {
      background: linear-gradient(135deg, #007cf0, #00dfd8);
      border: none;
    }
    .aba-conteudo { display: none; }
    .aba-conteudo.ativa { display: block; }

    /* CONSULTA */
    .painel {
      background: var(--cinza-card);
      padding: 18px;
      border-radius: 18px;
      border: 1px solid var(--borda);
      margin-bottom: 18px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      align-items: end;
    }
    .resultado-grupo {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--borda);
      border-radius: 14px;
      margin-top: 14px;
      overflow: hidden;
    }
    .resultado-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--borda);
      font-weight: 700;
      color: var(--azul);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .resultado-item {
      padding: 12px 14px;
      border-bottom: 1px solid var(--borda);
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .muted { color: var(--texto-sec); font-size: 13px; }
    .vazio { padding: 14px; color: var(--texto-sec); text-align: center; }
    .linha-dados {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }
    .chip {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(241,196,15,0.15);
      color: var(--amarelo);
      border: 1px solid rgba(241,196,15,0.25);
    }

/* Posicionamento dos bot√µes na consulta */
.acoes-consulta {
  display: flex;
  flex-direction: column;
  gap: 8px;
  justify-content: center;
  padding-left: 15px;
  border-left: 1px solid var(--borda);
}

.btn-editar-mini {
  background: rgba(46, 204, 113, 0.15);
  color: var(--verde);
  font-size: 12px;
  padding: 8px;
}

.btn-excluir-mini {
  background: rgba(255, 107, 107, 0.15);
  color: #ff6b6b;
  font-size: 12px;
  padding: 8px;
}

/* Ajuste no grid para acomodar a nova coluna de bot√µes */
.resultado-item {
  display: grid;
  grid-template-columns: 1fr auto; /* Texto √† esquerda, bot√µes √† direita */
  gap: 15px;
}
  </style>
</head>

<body>
<div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; flex-direction:column; justify-content:center; align-items:center; color:white; font-family:sans-serif;">
  <div style="width:50px; height:50px; border:5px solid #f3f3f3; border-top:5px solid var(--azul); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:15px;"></div>
  <div id="loader-texto">Processando...</div>
</div>

<style>
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
  <div class="app">
    <h2>Cadastro de Vistoria</h2>

    <div class="abas">
      <button class="aba-btn ativa" onclick="trocarAba('cadastro', this)">Cadastro</button>
      <button class="aba-btn" onclick="trocarAba('consulta', this)">Consulta</button>
      <button class="aba-btn" onclick="trocarAba('aba-timestamp', this)">üì∏ Timestamp</button>
    </div>

    <!-- CADASTRO (SEU HTML 1) -->
    <section id="cadastro" class="aba-conteudo ativa">
      <div class="topo">
        <label>SGM</label>
        <input type="text" id="sgm" list="listaSGM" oninput="filtrarSGM()" onchange="buscarSGM()">
        <datalist id="listaSGM"></datalist>

        <label>Vistoriador</label>
        <select id="vistoriador">
          <option value="">Selecione</option>
        </select>
      </div>

      <div id="ids"></div>

      <button class="btn-id" onclick="adicionarID()">‚ûï Adicionar IDGOM</button>
      <button class="btn-salvar" onclick="salvar()">üíæ Salvar</button>
    </section>

    <!-- CONSULTA (A PARTE QUE VOC√ä GOSTOU DO index-COPIA) -->
    <section id="consulta" class="aba-conteudo">
      <div class="painel">
        <div class="grid-3">
          <div>
            <label>Pesquisar SGM</label>
            <input id="qSgm" type="text" placeholder="Ex.: SGM-123">
          </div>
          <div>
            <label>Pesquisar IDGOM</label>
            <input id="qId" type="text" placeholder="Ex.: 456789">
          </div>
          <div>
            <label>Pesquisar Estrutura</label>
            <input id="qEstrutura" type="text" placeholder="Ex.: P-10">
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-consultar" onclick="consultarRegistros()">üîé Consultar</button>
          <button class="btn-limpar" onclick="limparConsulta()">Limpar</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Dica: voc√™ pode pesquisar por parte do texto (ex.: s√≥ "123" do IDGOM).
        </div>
      </div>

      <div id="resultadoConsulta" class="painel">
        <div class="vazio">Fa√ßa uma consulta para visualizar os registros.</div>
      </div>
    </section>
    <!-- TIMESTEMP -->
    <div id="aba-timestamp" style="display:none;">
  <div class="card">
    <h2 style="color: var(--azul); margin-bottom: 20px;">üì∏ Registro Fotogr√°fico (Timestamp)</h2>
    
    <div class="grid">
      <div class="campo">
        <label>SGM</label>
        <select id="time-sgm" onchange="atualizarDadosSgmTime()"></select>
      </div>
      <div class="campo">
        <label>IDGOM</label>
        <select id="time-idgom"></select>
      </div>
      <div class="campo">
        <label>Vistoriador</label>
        <select id="time-vistoriador"></select>
      </div>
    </div>

    <div id="info-gps" style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 15px;">
      <p>üìç <strong>Localiza√ß√£o:</strong> <span id="time-endereco">Obtendo...</span></p>
      <p>üåê <strong>Coordenadas:</strong> <span id="time-coords">...</span></p>
      <p>‚è∞ <strong>Data/Hora:</strong> <span id="time-datahora">--/--/-- --:--</span></p>
    </div>

    <div style="position: relative; width: 100%; max-width: 500px; margin: 0 auto; overflow: hidden; border-radius: 12px; border: 2px solid var(--azul);">
      <video id="video" width="100%" autoplay playsinline></video>
      <canvas id="canvas" style="display:none;"></canvas>
      
      <div id="watermark-preview" style="position: absolute; bottom: 10px; left: 10px; color: white; text-shadow: 1px 1px 2px black; font-size: 10px; pointer-events: none;">
      </div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
      <button class="btn-salvar" onclick="tirarFoto()" style="flex:1;">üì∏ Tirar Foto</button>
    </div>
    
    <div id="galeria-fotos" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;"></div>
  </div>
</div>
  </div>

  <script>

let idInfo = {};

    // 1. CONFIGURA√á√ÉO DE CONEX√ÉO (MESMA DO SEU HTML 1)
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzvZCS8Ba_nt0hzB7jXXNCqQgHVsqrH9hbgFvmZOqBp1M5LunmGYzAmltzqB3_z2SBJqA/exec";

    // 2. VARI√ÅVEIS GLOBAIS
    let sgms = [];
    let alimentadores = [];
    let idsSGM = [];
    let vozes = [];
    let observacoes = [];
    let tiposEquipe = [];


function preencherEstrutura(selectEl) {
  const box = selectEl.closest(".box");
  const idgom = selectEl.value;

  if (!idInfo[idgom]) return;

  const estruturaInput = box.querySelectorAll("input")[1];
  estruturaInput.value = idInfo[idgom].estrutura || "";
}

    // 3. BACKEND via FETCH (JSON normal)
    async function executarNoBackend(funcao, parametros = null) {
  // Liga o loader automaticamente
  mostrarLoader("Comunicando com o servidor...");
  
  const url =
    `${WEB_APP_URL}?action=${funcao}` +
    (parametros ? "&data=" + encodeURIComponent(JSON.stringify(parametros)) : "");
    
  try {
    const response = await fetch(url);
    const texto = await response.text();
    const json = JSON.parse(texto);
    
    // Desliga o loader ao terminar com sucesso
    esconderLoader();
    return json;
  } catch (e) {
    // Desliga o loader em caso de erro
    esconderLoader();
    console.error("Erro na comunica√ß√£o:", e);
    return null;
  }
}

    // ABAS
    async function trocarAba(idAba, botao = null) {
      // Esconde todas as se√ß√µes
      document.getElementById('cadastro').style.display = 'none';
      document.getElementById('consulta').style.display = 'none';
      document.getElementById('aba-timestamp').style.display = 'none';
      
      // Remove classe ativa de todos os bot√µes
      document.querySelectorAll(".aba-btn").forEach(btn => btn.classList.remove("ativa"));
      
      // Mostra a aba selecionada
      const alvo = document.getElementById(idAba);
      if(alvo) {
        alvo.style.display = 'block';
        alvo.classList.add("ativa");
      }
      if (botao) botao.classList.add("ativa");

      // L√≥gica espec√≠fica para o Timestamp
      if (idAba === 'aba-timestamp') {
        preencherCamposTimestamp(); // Sincroniza dados do cadastro
        await abrirTimestampCompleto();
      } else {
        pararCamera(); // Desliga a c√¢mera ao sair para economizar bateria
      }
    }

    // 4. CARREGAMENTO INICIAL
    // 4. CARREGAMENTO INICIAL (Vers√£o Robusta)
    async function carregarDadosIniciais() {
      console.log("Iniciando carregamento...");
      
      try {
        // Dispara todas as requisi√ß√µes ao mesmo tempo
        const [listaSGM, listaVist, listaVozes, listaObs, listaTipos] = await Promise.all([
          executarNoBackend("buscarListaSGM"),
          executarNoBackend("buscarVistoriadores"),
          executarNoBackend("buscarVozes"),
          executarNoBackend("buscarObservacoes"),
          executarNoBackend("buscarTiposEquipe")
        ]);

        // Processa SGM
        if (Array.isArray(listaSGM)) {
          sgms = listaSGM;
          atualizarListaSGM(sgms);
        }

        // Processa Vistoriadores
        if (Array.isArray(listaVist)) {
          const select = document.getElementById("vistoriador");
          select.innerHTML = '<option value="">Selecione</option>';
          listaVist.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            select.appendChild(opt);
          });
        }

        // Processa Listas Fixas (Se vier null, usa array vazio [])
        vozes = Array.isArray(listaVozes) ? listaVozes : [];
        observacoes = Array.isArray(listaObs) ? listaObs : [];
        tiposEquipe = Array.isArray(listaTipos) ? listaTipos : [];

        console.log("Dados carregados. Vozes encontradas:", vozes.length);

      } catch (err) {
        console.error("Erro cr√≠tico ao carregar dados:", err);
        alert("Erro ao conectar com a planilha. Verifique sua internet ou contate o administrador.");
      }
    }

    // 5. SGM AUTOCOMPLETE
    function filtrarSGM() {
      const valor = document.getElementById("sgm").value.toLowerCase();
      const filtrados = sgms.filter(s => s.toLowerCase().includes(valor));
      atualizarListaSGM(filtrados);
    }

    function atualizarListaSGM(lista) {
      const datalist = document.getElementById("listaSGM");
      datalist.innerHTML = "";
      lista.forEach(sgm => {
        const opt = document.createElement("option");
        opt.value = sgm;
        datalist.appendChild(opt);
      });
    }

    async function buscarSGM() {
  const sgm = document.getElementById("sgm").value;
  if (!sgm) return;

  const d = await executarNoBackend("buscarDadosSGM", { sgm });
  if (!d) return;

  alimentadores = d.alimentadores || [];
  idsSGM = d.ids || [];
  idInfo = d.idInfo || {}; // ‚Üê ESSA LINHA
}

    // 6. CADASTRO (MESMA IDEIA DO HTML 1)
    function adicionarID() {
  // ‚úÖ trava se o SGM ainda n√£o carregou os IDs
  if (!idsSGM || idsSGM.length === 0) {
    alert("Digite o SGM e depois clique fora do campo (ou aperte TAB/ENTER) para carregar os IDGOM antes de adicionar.");
    return;
  }

  const div = document.createElement("div");
  div.className = "box";
  div.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong style="color:#00AEEF">IDGOM</strong>
      <button class="btn-excluir-id" onclick="excluirIDGOM(this)">üóëÔ∏è Excluir IDGOM</button>
    </div>

    <label>Alimentador</label>
    <input list="listaAlimentador">
    <datalist id="listaAlimentador">
      ${alimentadores.map(a => `<option value="${a}">`).join("")}
    </datalist>

    <label>IDGOM</label>
    <select onchange="preencherEstrutura(this)">
      <option value="">Selecione</option>
      ${idsSGM.map(i => `<option value="${i}">${i}</option>`).join("")}
    </select>

    <label>Estrutura</label>
    <input type="text" readonly>

    <div class="vozes"></div>
    <button class="btn-voz" onclick="adicionarVoz(this)">‚ûï Adicionar Voz</button>
  `;
  document.getElementById("ids").appendChild(div);
}

    function adicionarVoz(botao) {
      const divVoz = document.createElement("div");
      divVoz.className = "voz";
      divVoz.innerHTML = `
        <label>Voz</label>
        <select>
          ${vozes.map(v => `<option value="${v}">${v}</option>`).join("")}
        </select>
        <label>Quantidade</label>
        <input type="number">
        <label>Observa√ß√£o</label>
        <select onchange="verificaWhats(this)">
          ${observacoes.map(o => `<option value="${o}">${o}</option>`).join("")}
        </select>
        <label>Descri√ß√£o</label>
        <textarea></textarea>
        <label>Tipo de Equipe</label>
        <select>
          ${tiposEquipe.map(t => `<option value="${t}">${t}</option>`).join("")}
        </select>
        <button class="whatsapp" style="display:none" onclick="enviarWhats(this)">üì≤ Enviar WhatsApp</button>
        <button class="btn-excluir" onclick="excluirVoz(this)">üóëÔ∏è Excluir Voz</button>
      `;
      botao.previousElementSibling.appendChild(divVoz);
    }

    function normalizarTexto(valor) {
      return String(valor || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();
    }

    function verificaWhats(select) {
      const btn = select.closest(".voz")?.querySelector(".whatsapp");
      if (!btn) return;
      const observacao = normalizarTexto(select.value);
      btn.style.display = observacao === "poda extra" ? "block" : "none";
    }

    function enviarWhats(btn) {
      const box = btn.closest(".box");
      const texto = `Projeto (SGM): ${document.getElementById("sgm").value}
      Alimentador: ${box.querySelectorAll("input")[0].value}
      Estrutura: ${box.querySelectorAll("input")[1].value}
      IDGOM: ${box.querySelector("select").value}
      Descri√ß√£o: ${btn.parentElement.querySelector("textarea").value}`.trim();
      window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`);
    }

    async function salvar() {
      const payload = {
        sgm: document.getElementById("sgm").value,
        vistoriador: document.getElementById("vistoriador").value,
        registros: []
      };

      if (!payload.sgm || !payload.vistoriador) {
        return alert("SGM e Vistoriador s√£o obrigat√≥rios.");
      }

      document.querySelectorAll(".box").forEach(box => {
        const inputs = box.querySelectorAll("input");
        const alimentador = inputs[0].value;
        const idgom = box.querySelector("select").value;
        const estrutura = inputs[1].value;

        box.querySelectorAll(".voz").forEach(v => {
          const selects = v.querySelectorAll("select");
          payload.registros.push({
            alimentador, idgom, estrutura,
            voz: selects[0].value,
            quantidade: v.querySelector("input").value,
            observacao: selects[1].value,
            descricao: v.querySelector("textarea").value,
            tipoEquipe: selects[2].value
          });
        });
      });

      const senha = prompt("Digite sua senha:");
      if (!senha) return alert("Senha obrigat√≥ria.");

      const res = await executarNoBackend("salvarBaseComSenha", { payload, senha });
      if (res && res.ok) {
        alert("Dados salvos com sucesso!");
        location.reload();
      } else {
        alert("Erro ou senha incorreta.");
      }
    }

    function excluirVoz(botao) {
      if (confirm("Deseja excluir esta voz?")) botao.closest(".voz").remove();
    }

    function excluirIDGOM(botao) {
      if (confirm("Deseja excluir este IDGOM?")) botao.closest(".box").remove();
    }

    // -------------------------
    // CONSULTA (aba que voc√™ queria)
    // -------------------------
    async function consultarRegistros() {
      const filtros = {
        sgm: document.getElementById("qSgm").value,
        idgom: document.getElementById("qId").value,
        estrutura: document.getElementById("qEstrutura").value
      };
      const res = await executarNoBackend("consultarRegistros", filtros);
      renderizarConsulta(res || []);
    }

    function limparConsulta() {
      document.getElementById("qSgm").value = "";
      document.getElementById("qId").value = "";
      document.getElementById("qEstrutura").value = "";
      document.getElementById("resultadoConsulta").innerHTML =
        '<div class="vazio">Fa√ßa uma consulta para visualizar os registros.</div>';
    }

    // Helpers para aguentar nomes de colunas diferentes no Sheet
    function pick(obj, keys, fallback = "") {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
      }
      return fallback;
    }

function renderizarConsulta(lista) {
  const box = document.getElementById("resultadoConsulta");
  if (!lista.length) {
    box.innerHTML = '<div class="vazio">Nenhum registro encontrado.</div>';
    return;
  }
  box.innerHTML = "";

  lista.forEach(reg => {
    // --- ATRIBUI√á√ÉO DAS VARI√ÅVEIS (A corre√ß√£o que voc√™ pediu) ---
    const linha       = reg.linha;
    const sgm         = reg.sgm || "-";
    const idgom       = reg.idgom || "-";
    const estrutura   = reg.estrutura || "-";
    const alimentador = reg.alimentador || "-";
    const voz         = reg.voz || "-";
    const qtd         = reg.quantidade || "-";
    const obs         = reg.observacao || "-";
    const desc        = reg.descricao || "-";
    const tipoEq      = reg.tipo_equipe || "-";
    const vist        = reg.vistoriador || "-";
    const data        = reg.data ? new Date(reg.data).toLocaleString() : "";

    const grupo = document.createElement("div");
    grupo.className = "resultado-grupo";
    grupo.id = `grupo-${linha}`;

    // --- MONTAGEM DO HTML USANDO AS VARI√ÅVEIS ---
    grupo.innerHTML = `
      <div class="resultado-header">
        <div>SGM: <span id="val-sgm-${linha}">${sgm}</span> 
             <span class="chip">IDGOM: <span id="val-idgom-${linha}">${idgom}</span></span></div>
        <div class="muted">${data}</div>
      </div>
      <div class="resultado-item">
        <div id="dados-${linha}">
          <div class="linha-dados">
            <div><strong>Estrutura:</strong> <span id="val-est-${linha}">${estrutura}</span></div>
            <div><strong>Alimentador:</strong> <span id="val-alm-${linha}">${alimentador}</span></div>
            <div><strong>Voz:</strong> <span id="val-voz-${linha}">${voz}</span></div>
            <div><strong>Qtd:</strong> <span id="val-qtd-${linha}">${qtd}</span></div>
            <div><strong>Tipo Equipe:</strong> <span id="val-teq-${linha}">${tipoEq}</span></div>
            <div><strong>Vistoriador:</strong> <span id="val-vist-${linha}">${vist}</span></div>
          </div>
          <div class="muted"><strong>Obs:</strong> <span id="val-obs-${linha}">${obs}</span></div>
          <div class="muted"><strong>Desc:</strong> <span id="val-desc-${linha}">${desc}</span></div>
        </div>
        <div class="acoes-consulta" id="acoes-${linha}">
          <button class="btn-editar-mini" onclick="habilitarEdicao(${linha})">‚úèÔ∏è Editar</button>
          <button class="btn-excluir-mini" onclick="excluirDireto(${linha})">üóëÔ∏è Excluir</button>
        </div>
      </div>
    `;
    box.appendChild(grupo);
  });
}

async function editarDireto(linha) {
  const novoVistoriador = document.getElementById("vistoriador").value;
  
  if (!novoVistoriador) {
    alert("Por favor, selecione um Vistoriador na aba 'Cadastro' antes de atualizar.");
    return;
  }

  if (confirm("Deseja atualizar este registro com o novo Vistoriador e Data Atual?")) {
    // Reutiliza a rota existente 'editarRegistro', mas com a l√≥gica nova
    const res = await executarNoBackend("editarRegistro", { 
      linha: linha, 
      vistoriador: novoVistoriador 
    });
    
    if (res && res.ok) {
      alert("Registro atualizado!");
      consultarRegistros(); // Recarrega a lista
    }
  }
}

async function excluirDireto(linha) {
  if (confirm("Tem certeza que deseja excluir permanentemente este registro?")) {
    // Reutiliza a rota existente 'excluirRegistro'
    const res = await executarNoBackend("excluirRegistro", { linha: linha });
    if (res && res.ok) {
      alert("Registro exclu√≠do!");
      consultarRegistros(); // Recarrega a lista
    }
  }
}
// Fun√ß√µes de A√ß√£o Direta na Consulta
    async function editarDireto(linha) {
      // Tenta pegar o vistoriador selecionado na aba Cadastro
      const novoVistoriador = document.getElementById("vistoriador").value;
      
      if (!novoVistoriador) {
        alert("Por favor, selecione um Vistoriador no topo da tela (aba Cadastro) antes de clicar em Atualizar.");
        return;
      }

      if (confirm("Deseja atualizar este registro? A data/hora e o vistoriador ser√£o atualizados para os valores atuais.")) {
        // Envia para o backend usando a rota que j√° existe no seu Code.gs
        const res = await executarNoBackend("editarRegistro", { 
          payload: { 
            id: linha, 
            vistoriador: novoVistoriador 
          } 
        });
        
        if (res && res.ok) {
          alert("Registro atualizado com sucesso!");
          consultarRegistros(); // Atualiza a lista na tela
        } else {
          alert("Erro ao atualizar: " + (res.error || "Erro desconhecido"));
        }
      }
    }

    async function excluirDireto(linha) {
      if (confirm("Tem certeza que deseja excluir permanentemente este registro da planilha?")) {
        // Envia para o backend usando a rota que j√° existe no seu Code.gs
        const res = await executarNoBackend("excluirRegistro", { id: linha });
        
        if (res && res.ok) {
          alert("Registro exclu√≠do!");
          consultarRegistros(); // Atualiza a lista na tela
        } else {
          alert("Erro ao excluir: " + (res.error || "Erro desconhecido"));
        }
      }
    }

function habilitarEdicao(linha) {
  const campos = [
    {id: `val-est-${linha}`},
    {id: `val-alm-${linha}`},
    {id: `val-voz-${linha}`},
    {id: `val-qtd-${linha}`},
    {id: `val-obs-${linha}`},
    {id: `val-desc-${linha}`},
    {id: `val-vist-${linha}`} // <-- ADICIONE ESTA LINHA
  ];

  campos.forEach(c => {
    const el = document.getElementById(c.id);
    const valorAtual = el.innerText;
    // Transforma o texto em uma caixa de edi√ß√£o azulada
    el.innerHTML = `<input type="text" class="editando" id="input-${c.id}" value="${valorAtual}" style="padding:2px 5px; margin:0; height:auto; width:100%;">`;
  });

  // Troca os bot√µes para Salvar/Cancelar
  const divAcoes = document.getElementById(`acoes-${linha}`);
  divAcoes.innerHTML = `
    <button class="btn-salvar-mini" onclick="salvarEdicao(${linha})">üíæ Salvar</button>
    <button class="btn-limpar" style="padding:5px; font-size:11px" onclick="consultarRegistros()">‚ùå Sair</button>
  `;
}

    async function salvarEdicao(linha) {
  // Agora pegamos o valor do INPUT que criamos na linha, n√£o mais o do topo da p√°gina
  const vistDigitado = document.getElementById(`input-val-vist-${linha}`).value;

  if (!vistDigitado) {
    alert("O campo Vistoriador n√£o pode ficar vazio.");
    return;
  }

  const dados = {
    linha: linha,
    vistoriador: vistDigitado, // <-- Usa o nome que voc√™ editou
    sgm: document.getElementById(`val-sgm-${linha}`).innerText,
    idgom: document.getElementById(`val-idgom-${linha}`).innerText,
    estrutura: document.getElementById(`input-val-est-${linha}`).value,
    alimentador: document.getElementById(`input-val-alm-${linha}`).value,
    voz: document.getElementById(`input-val-voz-${linha}`).value,
    quantidade: document.getElementById(`input-val-qtd-${linha}`).value,
    observacao: document.getElementById(`input-val-obs-${linha}`).value,
    descricao: document.getElementById(`input-val-desc-${linha}`).value,
    tipoEquipe: document.getElementById(`val-teq-${linha}`).innerText 
  };

  const res = await executarNoBackend("editarRegistro", { payload: dados });
  if (res && res.ok) {
    alert("Registro atualizado!");
    consultarRegistros();
  } else {
    alert("Erro ao salvar altera√ß√µes.");
  }
}

function mostrarLoader(texto = "Processando...") {
  document.getElementById("loader-texto").innerText = texto;
  document.getElementById("loader").style.display = "flex";
}

function esconderLoader() {
  document.getElementById("loader").style.display = "none";
}

let localizacaoAtual = { lat: "", lng: "", endereco: "" };

// Inicia o GPS e a C√¢mera quando abrir a aba
async function abrirAbaTimestamp() {
  mostrarLoader("Iniciando C√¢mera e GPS...");
  document.getElementById('aba-timestamp').style.display = 'block';
  document.getElementById('aba-cadastro').style.display = 'none';
  document.getElementById('aba-consulta').style.display = 'none';
  
  iniciarCamera();
  obterGps();
  setInterval(atualizarRelogio, 1000);
  esconderLoader();
}

function atualizarRelogio() {
  const agora = new Date().toLocaleString();
  document.getElementById("time-datahora").innerText = agora;
}

// Obt√©m Localiza√ß√£o Real
function obterGps() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      document.getElementById("time-coords").innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      localizacaoAtual.lat = lat;
      localizacaoAtual.lng = lng;
      
      // Busca endere√ßo simplificado (Reverso Geocoding via API gratuita se desejar ou apenas as coordenadas)
      document.getElementById("time-endereco").innerText = "Coordenadas obtidas com sucesso";
    });
  }
}

// Configura C√¢mera
async function iniciarCamera() {
  const video = document.getElementById('video');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream;
  } catch (err) {
    alert("Erro ao acessar c√¢mera: " + err);
  }
}

function tirarFoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  
  // Define tamanho da foto igual ao v√≠deo
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Desenha a foto
  ctx.drawImage(video, 0, 0);
  
  // Adiciona Marca d'√°gua (Timestamp)
  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.shadowColor = "black";
  ctx.shadowBlur = 4;
  
  const sgm = document.getElementById("time-sgm").value;
  const id = document.getElementById("time-idgom").value;
  const vist = document.getElementById("time-vistoriador").value;
  const data = new Date().toLocaleString();
  const coords = document.getElementById("time-coords").innerText;

  ctx.fillText(`SGM: ${sgm} | ID: ${id}`, 20, canvas.height - 80);
  ctx.fillText(`Vist: ${vist} | ${data}`, 20, canvas.height - 50);
  ctx.fillText(`Loc: ${coords}`, 20, canvas.height - 20);

  // Criar elemento de download
  const link = document.createElement('a');
  link.download = `Vistoria_${sgm}_${Date.now()}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click(); // Salva no dispositivo automaticamente

  // Adiciona na galeria visual do app
  const imgPreview = document.createElement('img');
  imgPreview.src = link.href;
  imgPreview.style.width = "80px";
  imgPreview.style.borderRadius = "5px";
  document.getElementById("galeria-fotos").appendChild(imgPreview);
}
let streamCamera = null;

async function abrirTimestampCompleto() {
  mostrarLoader("Acessando C√¢mera e GPS...");
  try {
    obterGps();
    const video = document.getElementById('video');
    streamCamera = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: "environment" }, 
      audio: false 
    });
    video.srcObject = streamCamera;
  } catch (err) {
    alert("Erro: D√™ permiss√£o de C√¢mera e GPS no navegador.");
    console.error(err);
  }
  esconderLoader();
}

function pararCamera() {
  if (streamCamera) {
    streamCamera.getTracks().forEach(track => track.stop());
    streamCamera = null;
  }
}

function preencherCamposTimestamp() {
  // Sincroniza o SGM e Vistoriador da aba Cadastro para o Timestamp
  const sgmVal = document.getElementById("sgm").value;
  const vistVal = document.getElementById("vistoriador").value;
  
  const tSgm = document.getElementById("time-sgm");
  const tVist = document.getElementById("time-vistoriador");
  const tIdgom = document.getElementById("time-idgom");

  tSgm.innerHTML = `<option value="${sgmVal}">${sgmVal || 'SGM n√£o definido'}</option>`;
  tVist.innerHTML = `<option value="${vistVal}">${vistVal || 'Selecione no cadastro'}</option>`;
  
  // Copia os IDs dispon√≠veis se houver algum selecionado
  const idOriginal = document.querySelector(".box select");
  if(idOriginal) {
     tIdgom.innerHTML = idOriginal.innerHTML;
     tIdgom.value = idOriginal.value;
  } else {
     tIdgom.innerHTML = '<option value="">Aguardando ID...</option>';
  }
}

    window.onload = carregarDadosIniciais;
  </script>
</body>
</html>

